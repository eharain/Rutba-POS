# ============================================================
# Rutba POS â€” Docker Compose
# ============================================================
#
# Pre-requisite:
#   node scripts/generate-docker-env.js
#
# Start:
#   docker compose --env-file .env.docker up -d --build
#
# Rebuild one service:
#   docker compose --env-file .env.docker up -d --build strapi
#
# Logs:
#   docker compose logs -f strapi auth stock
# ============================================================

services:
  # --------------------------------------------------------
  # MySQL Database
  # --------------------------------------------------------
  mysql:
    image: mysql:8.0
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${STRAPI_MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${STRAPI_DATABASE_NAME}
      MYSQL_USER: ${STRAPI_DATABASE_USERNAME}
      MYSQL_PASSWORD: ${STRAPI_DATABASE_PASSWORD}
    ports:
      - "${STRAPI_DATABASE_PORT:-3306}:3306"
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${STRAPI_MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # --------------------------------------------------------
  # Strapi API
  # --------------------------------------------------------
  strapi:
    build:
      context: .
      target: strapi
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    ports:
      - "${PORT_STRAPI}:${PORT_STRAPI}"
    environment:
      HOST: ${STRAPI_HOST}
      PORT: ${PORT_STRAPI}
      DATABASE_CLIENT: ${STRAPI_DATABASE_CLIENT}
      DATABASE_HOST: mysql
      DATABASE_PORT: 3306
      DATABASE_NAME: ${STRAPI_DATABASE_NAME}
      DATABASE_USERNAME: ${STRAPI_DATABASE_USERNAME}
      DATABASE_PASSWORD: ${STRAPI_DATABASE_PASSWORD}
      DATABASE_SSL: "false"
      APP_KEYS: ${STRAPI_APP_KEYS}
      API_TOKEN_SALT: ${STRAPI_API_TOKEN_SALT}
      ADMIN_JWT_SECRET: ${STRAPI_ADMIN_JWT_SECRET}
      TRANSFER_TOKEN_SALT: ${STRAPI_TRANSFER_TOKEN_SALT}
      JWT_SECRET: ${STRAPI_JWT_SECRET}
      ENCRYPTION_KEY: ${STRAPI_ENCRYPTION_KEY}
      CORS_ORIGINS: ${CORS_ORIGINS}
      NODE_ENV: production
    volumes:
      - strapi_uploads:/app/pos-strapi/public/uploads

  # --------------------------------------------------------
  # Auth Portal
  # --------------------------------------------------------
  auth:
    build:
      context: .
      target: auth
      args: &global-build-args
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
        NEXT_PUBLIC_IMAGE_URL: ${NEXT_PUBLIC_IMAGE_URL}
        NEXT_PUBLIC_AUTH_URL: ${NEXT_PUBLIC_AUTH_URL}
        NEXT_PUBLIC_STOCK_URL: ${NEXT_PUBLIC_STOCK_URL}
        NEXT_PUBLIC_SALE_URL: ${NEXT_PUBLIC_SALE_URL}
        NEXT_PUBLIC_WEB_URL: ${NEXT_PUBLIC_WEB_URL}
        NEXT_PUBLIC_WEB_USER_URL: ${NEXT_PUBLIC_WEB_USER_URL}
        NEXT_PUBLIC_CRM_URL: ${NEXT_PUBLIC_CRM_URL}
        NEXT_PUBLIC_HR_URL: ${NEXT_PUBLIC_HR_URL}
        NEXT_PUBLIC_ACCOUNTS_URL: ${NEXT_PUBLIC_ACCOUNTS_URL}
        NEXT_PUBLIC_PAYROLL_URL: ${NEXT_PUBLIC_PAYROLL_URL}
        NEXT_PUBLIC_IMAGE_HOST_PROTOCOL: ${NEXT_PUBLIC_IMAGE_HOST_PROTOCOL}
        NEXT_PUBLIC_IMAGE_HOST_NAME: ${NEXT_PUBLIC_IMAGE_HOST_NAME}
        NEXT_PUBLIC_IMAGE_HOST_PORT: ${NEXT_PUBLIC_IMAGE_HOST_PORT}
        WEB_NEXTAUTH_SECRET: ${WEB_NEXTAUTH_SECRET}
        WEB_NEXTAUTH_URL: ${WEB_NEXTAUTH_URL}
        WEB_GOOGLE_CLIENT_KEY: ${WEB_GOOGLE_CLIENT_KEY}
        WEB_GOOGLE_SECRET_KEY: ${WEB_GOOGLE_SECRET_KEY}
    restart: unless-stopped
    depends_on:
      - strapi
    ports:
      - "${PORT_AUTH}:${PORT_AUTH}"
    environment:
      PORT: ${PORT_AUTH}
      HOSTNAME: 0.0.0.0

  # --------------------------------------------------------
  # Stock Management
  # --------------------------------------------------------
  stock:
    build:
      context: .
      target: stock
      args: *global-build-args
    restart: unless-stopped
    depends_on:
      - strapi
    ports:
      - "${PORT_STOCK}:${PORT_STOCK}"
    environment:
      PORT: ${PORT_STOCK}
      HOSTNAME: 0.0.0.0

  # --------------------------------------------------------
  # Point of Sale
  # --------------------------------------------------------
  sale:
    build:
      context: .
      target: sale
      args: *global-build-args
    restart: unless-stopped
    depends_on:
      - strapi
    ports:
      - "${PORT_SALE}:${PORT_SALE}"
    environment:
      PORT: ${PORT_SALE}
      HOSTNAME: 0.0.0.0

  # --------------------------------------------------------
  # Public Website
  # --------------------------------------------------------
  web:
    build:
      context: .
      target: web
      args: *global-build-args
    restart: unless-stopped
    depends_on:
      - strapi
    ports:
      - "${PORT_WEB}:${PORT_WEB}"
    environment:
      PORT: ${PORT_WEB}
      HOSTNAME: 0.0.0.0
      NEXTAUTH_SECRET: ${WEB_NEXTAUTH_SECRET}
      NEXTAUTH_URL: ${WEB_NEXTAUTH_URL}
      GOOGLE_CLIENT_KEY: ${WEB_GOOGLE_CLIENT_KEY}
      GOOGLE_SECRET_KEY: ${WEB_GOOGLE_SECRET_KEY}

  # --------------------------------------------------------
  # My Orders / Web User
  # --------------------------------------------------------
  web-user:
    build:
      context: .
      target: web-user
      args: *global-build-args
    restart: unless-stopped
    depends_on:
      - strapi
    ports:
      - "${PORT_WEB_USER}:${PORT_WEB_USER}"
    environment:
      PORT: ${PORT_WEB_USER}
      HOSTNAME: 0.0.0.0

  # --------------------------------------------------------
  # CRM
  # --------------------------------------------------------
  crm:
    build:
      context: .
      target: crm
      args: *global-build-args
    restart: unless-stopped
    depends_on:
      - strapi
    ports:
      - "${PORT_CRM}:${PORT_CRM}"
    environment:
      PORT: ${PORT_CRM}
      HOSTNAME: 0.0.0.0

  # --------------------------------------------------------
  # HR
  # --------------------------------------------------------
  hr:
    build:
      context: .
      target: hr
      args: *global-build-args
    restart: unless-stopped
    depends_on:
      - strapi
    ports:
      - "${PORT_HR}:${PORT_HR}"
    environment:
      PORT: ${PORT_HR}
      HOSTNAME: 0.0.0.0

  # --------------------------------------------------------
  # Accounts
  # --------------------------------------------------------
  accounts:
    build:
      context: .
      target: accounts
      args: *global-build-args
    restart: unless-stopped
    depends_on:
      - strapi
    ports:
      - "${PORT_ACCOUNTS}:${PORT_ACCOUNTS}"
    environment:
      PORT: ${PORT_ACCOUNTS}
      HOSTNAME: 0.0.0.0

  # --------------------------------------------------------
  # Payroll
  # --------------------------------------------------------
  payroll:
    build:
      context: .
      target: payroll
      args: *global-build-args
    restart: unless-stopped
    depends_on:
      - strapi
    ports:
      - "${PORT_PAYROLL}:${PORT_PAYROLL}"
    environment:
      PORT: ${PORT_PAYROLL}
      HOSTNAME: 0.0.0.0

volumes:
  mysql_data:
  strapi_uploads:
